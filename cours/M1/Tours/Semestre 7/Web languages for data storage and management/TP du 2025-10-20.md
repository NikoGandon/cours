# Fiche de r√©vision Neo4j - Compl√®te

## 0. Cr√©ation de n≈ìuds et relations (CREATE)

### 0.1 Cr√©er un film et des acteurs - "The Departed"

**‚ö†Ô∏è IMPORTANT :** Ex√©cuter tout le code en **un seul bloc** ! Sinon, les instructions CREATE pour les arcs doivent √™tre pr√©c√©d√©es d'un MATCH pour r√©cup√©rer les n≈ìuds.

```cypher
CREATE (departed:Movie {title:'The Departed', released:2006, tagline:'Good and Evil'})
CREATE (leo:Person {name:'Leonardo Di Caprio', born: 1974})
CREATE (matt:Person {name:'Matt Damon', born: 1970})
CREATE (leo)-[:ACTED_IN {roles: ['Billy']}]->(departed)
CREATE (matt)-[:ACTED_IN {roles: ['Colin Sullivan']}]->(departed)
```

**Ce que fait ce code :**
- Cr√©e un n≈ìud `Movie` avec les propri√©t√©s `title`, `released`, `tagline`
- Cr√©e 2 n≈ìuds `Person` avec les propri√©t√©s `name`, `born`
- Cr√©e des relations `ACTED_IN` avec la propri√©t√© `roles`

### 0.2 Ajouter une relation √† un n≈ìud existant

Si le n≈ìud existe d√©j√† (comme Jack Nicholson), il faut d'abord le r√©cup√©rer avec `MATCH` :

```cypher
MATCH (jack:Person {name: 'Jack Nicholson'})
MATCH (departed:Movie {title:'The Departed'})
CREATE (jack)-[:ACTED_IN {roles: ['Frank Costello']}]->(departed)
```

**Principe cl√© :** `CREATE` cr√©e toujours de nouveaux n≈ìuds. Pour lier des n≈ìuds existants, on doit d'abord les `MATCH`.

---

## 1. Visualiser tous les n≈ìuds et relations

Affiche l'ensemble du graphe avec tous les n≈ìuds, relations et leurs connexions.

```cypher
MATCH (n)-[r]->(m)
RETURN n, r, m
```

**R√©sultat :** 174 n≈ìuds et 256 relations

---

## 2. Statistiques du graphe

Le graphe contient :
- **174 n≈ìuds**
- **256 relations**

---

## 3. Requ√™tes sur un film sp√©cifique

### 3.1 Relations autour de "The Departed"

Trouve toutes les entit√©s connect√©es au film "The Departed" (acteurs, r√©alisateurs, etc.).

```cypher
MATCH (m:Movie {title: "The Departed"})-[r]-(n)
RETURN m, r, n
```

**Note :** Le `-` (sans fl√®che) signifie "dans n'importe quelle direction".

---

## 4. Relations Personne-Film

### 4.1 Toutes les relations entre personnes et films

Affiche toutes les connexions entre les personnes et les films (peu importe le type de relation).

```cypher
MATCH (p:Person)-[r]-(m:Movie)
RETURN p, r, m
```

### 4.2 Uniquement les acteurs

Filtre pour n'afficher que les personnes ayant jou√© dans des films.

```cypher
MATCH (p:Person)-[r:ACTED_IN]->(m:Movie)
RETURN p, r, m
```

---

## 5. R√©alisateurs-Acteurs

### 5.1 Personnes ayant r√©alis√© ET jou√© dans un m√™me film

Trouve les personnes qui ont √† la fois r√©alis√© et jou√© dans le m√™me film.

```cypher
MATCH (p:Person)-[:DIRECTED]->(m:Movie)
MATCH (p)-[:ACTED_IN]->(m)
RETURN p, m
```

### 5.2 Version optimis√©e avec un seul MATCH

M√™me requ√™te mais avec une syntaxe plus concise.

```cypher
MATCH (p:Person)-[:ACTED_IN]->(m:Movie)<-[:DIRECTED]-(p)
RETURN p, m
```

**Astuce :** La fl√®che `<-` indique la direction de la relation.

---

## 6. Critiques de films

### 6.1 Tous les critiques

Trouve toutes les personnes ayant critiqu√© des films.

```cypher
MATCH (p:Person)-[r:REVIEWED]-(m:Movie)
RETURN p
```

### 6.2 Films avec plusieurs critiques

Identifie les films ayant re√ßu plus d'une critique.

```cypher
MATCH (m:Movie)-[:REVIEWED]-(reviewer:Person)
WITH m, collect(reviewer) AS reviewers
WHERE size(reviewers) > 1
RETURN m, reviewers
```

**Principe :** `WITH` permet d'agr√©ger les r√©sultats avant de filtrer.

---

## 7. Filtres temporels

### 7.1 Films r√©cents (apr√®s 2010)

Liste tous les films sortis apr√®s 2010.

```cypher
MATCH (m:Movie)
WHERE m.released > 2010
RETURN m
```

### 7.2 Acteurs dans des films r√©cents

Trouve les acteurs ayant jou√© dans des films sortis apr√®s 2010.

```cypher
MATCH (actor:Person)-[r:ACTED_IN]->(m:Movie)
WHERE m.released > 2010
RETURN actor, m
```

---

## 8. Co-acteurs

### 8.1 Paires d'acteurs dans des films r√©cents

Identifie les paires d'acteurs ayant jou√© ensemble dans des films post-2010.

```cypher
MATCH (a1:Person)-[:ACTED_IN]->(m:Movie)<-[:ACTED_IN]-(a2:Person)
WHERE m.released > 2010 AND elementId(a1) < elementId(a2)
RETURN a1.name AS Acteur1, a2.name AS Acteur2, m.title AS Film, m.released AS Annee
```

**Note :** `elementId(a1) < elementId(a2)` √©vite les doublons (A-B et B-A).

### 8.2 Co-acteurs r√©currents

Trouve les paires d'acteurs ayant jou√© ensemble dans plusieurs films.

```cypher
MATCH (a1:Person)-[:ACTED_IN]->(m:Movie)<-[:ACTED_IN]-(a2:Person)
WITH a1, a2, collect(m) AS movies
WHERE elementId(a1) < elementId(a2) AND size(movies) > 1
UNWIND movies AS movie
RETURN a1, a2, movie
```

**Principe :** `UNWIND` transforme une liste en lignes individuelles.

---

## 9. Relations entre critiques

### 9.1 R√©seau de followers (version simple)

Trouve tous les critiques qui suivent d'autres critiques (jusqu'√† plusieurs niveaux).

```cypher
MATCH (reviewer1:Person)-[:FOLLOWS*1..]->(reviewer2:Person)
RETURN reviewer1, reviewer2
```

**Note :** `*1..` signifie "1 relation ou plus" (chemins de longueur variable).

### 9.2 R√©seau de followers (version group√©e)

Pour chaque critique, affiche tous les critiques qu'il suit (directement ou indirectement).

```cypher
MATCH (r1:Person)-[:FOLLOWS*1..]->(r2:Person)
RETURN r1.name AS reviewer, collect(DISTINCT r2.name) AS follows_network
```

**Am√©lioration :** Cette version regroupe les r√©sultats par critique et √©limine les doublons.

---

## 10. Exploration du r√©seau

### 10.1 R√©seau de Clint Eastwood (3 degr√©s max)

Explore le r√©seau de Clint Eastwood jusqu'√† 3 degr√©s de s√©paration.

```cypher
MATCH (clint:Person {name: "Clint Eastwood"})
MATCH path = (clint)-[*1..3]-(n)
RETURN DISTINCT n
LIMIT 12
```

**Principe :** `[*1..3]` signifie "entre 1 et 3 relations de distance".

---

## 11. Calculs d'√¢ge

### 11.1 √Çge des acteurs dans "Apollo 13"

Calcule l'√¢ge de chaque acteur lors du tournage d'Apollo 13.

```cypher
MATCH (actor:Person)-[:ACTED_IN]->(m:Movie {title: "Apollo 13"})
RETURN m, actor.name, m.released - actor.born AS age_lors_tournage
```

### 11.2 √Çge moyen du casting d'Apollo 13

Calcule l'√¢ge moyen des acteurs d'Apollo 13 lors du tournage.

```cypher
MATCH (actor:Person)-[:ACTED_IN]->(m:Movie {title: "Apollo 13"})
RETURN m, avg(m.released - actor.born) AS age_moyen
```

**Fonction :** `avg()` calcule la moyenne.

---

## 12. Analyses statistiques

### 12.1 √Çge moyen par film

Calcule l'√¢ge moyen des acteurs pour chaque film.

```cypher
MATCH (m:Movie)<-[:ACTED_IN]-(actor:Person)
RETURN m, avg(m.released - actor.born) AS age_moyen
```

### 12.2 Top 10 des films avec les castings les plus jeunes

Classe les films par √¢ge moyen des acteurs (du plus jeune au plus √¢g√©).

```cypher
MATCH (m:Movie)<-[:ACTED_IN]-(actor:Person)
RETURN m, avg(m.released - actor.born) AS age_moyen
ORDER BY age_moyen ASC
LIMIT 10
```

**Clauses :** `ORDER BY` trie les r√©sultats, `LIMIT` restreint le nombre de lignes.

---

## 13. Corrections et bonnes pratiques

### ‚ö†Ô∏è Erreurs courantes corrig√©es :

1. **Cr√©er des relations sans MATCH pr√©alable** : Si le n≈ìud existe d√©j√†, il faut le r√©cup√©rer avec `MATCH` avant de cr√©er une relation
2. **Variable `actor` non d√©finie** : Toujours d√©finir la variable dans le `MATCH`
3. **Direction des relations** : `(m:Movie)-[r:ACTED_IN]-(actor)` ‚Üí Correct : `(m:Movie)<-[:ACTED_IN]-(actor)`

### ‚úÖ Conseils Neo4j :

- **`elementId()`** : Pour √©viter les doublons dans les paires (A-B vs B-A)
- **`collect()`** : Pour agr√©ger des r√©sultats en liste
- **`DISTINCT`** : √âlimine les doublons dans les r√©sultats
- **`*1..` ou `*1..3`** : Pour les chemins de longueur variable
- **`WITH`** : Pour encha√Æner des √©tapes de traitement (agr√©gation puis filtrage)
- **`UNWIND`** : Pour transformer une liste en lignes
- **CREATE en bloc** : Toujours cr√©er n≈ìuds + relations en un seul bloc si possible

### üìù Syntaxe des relations :

- `(a)-[r]->(b)` : relation dirig√©e de a vers b
- `(a)-[r]-(b)` : relation dans n'importe quelle direction
- `(a)<-[r]-(b)` : relation de b vers a
- `(a)-[:TYPE]->(b)` : relation avec un type sp√©cifique
- `(a)-[*1..3]->(b)` : chemin de 1 √† 3 relations

---

## 14. R√©sum√© des fonctions utiles

| Fonction | Usage | Exemple |
|----------|-------|---------|
| `count()` | Compte les √©l√©ments | `RETURN count(n)` |
| `avg()` | Moyenne | `RETURN avg(m.released)` |
| `sum()` | Somme | `RETURN sum(m.budget)` |
| `min()` / `max()` | Min / Max | `RETURN max(m.released)` |
| `collect()` | Agr√®ge en liste | `collect(actor.name)` |
| `size()` | Taille d'une liste | `size(movies)` |
| `elementId()` | ID unique du n≈ìud | `elementId(n)` |

---

## 15. Anti-patterns : Erreurs √† √©viter absolument

### ‚ùå Erreur 1 : Cr√©er au lieu de lier

**MAUVAIS :**
```cypher
CREATE (p:Person {name:"Jack"})-[:ACTED_IN]->(m:Movie {title:"Film"})
```
**Probl√®me :** Cr√©e TOUJOURS de nouveaux n≈ìuds, m√™me s'ils existent d√©j√† ‚Üí doublons garantis !

**‚úÖ BON :**
```cypher
MATCH (p:Person {name:"Jack"})
MATCH (m:Movie {title:"Film"})
CREATE (p)-[:ACTED_IN]->(m)
```

### ‚ùå Erreur 2 : Oublier d'√©viter les doublons dans les paires

**MAUVAIS :**
```cypher
MATCH (a1:Person)-[:ACTED_IN]->(m)<-[:ACTED_IN]-(a2:Person)
RETURN a1, a2, m
```
**Probl√®me :** Retourne Tom-Jerry ET Jerry-Tom (doublon)

**‚úÖ BON :**
```cypher
MATCH (a1:Person)-[:ACTED_IN]->(m)<-[:ACTED_IN]-(a2:Person)
WHERE elementId(a1) < elementId(a2)
RETURN a1, a2, m
```

### ‚ùå Erreur 3 : Mauvaise direction de relation

**MAUVAIS :**
```cypher
MATCH (m:Movie)-[:ACTED_IN]->(p:Person)  // Film joue dans personne ???
RETURN p
```

**‚úÖ BON :**
```cypher
MATCH (p:Person)-[:ACTED_IN]->(m:Movie)  // Personne joue dans film
RETURN p
```

### ‚ùå Erreur 4 : Filtrer avant d'agr√©ger

**MAUVAIS :**
```cypher
MATCH (m:Movie)<-[:REVIEWED]-(r:Person)
WHERE count(r) > 1  // count() ne fonctionne pas ici !
RETURN m
```

**‚úÖ BON :**
```cypher
MATCH (m:Movie)<-[:REVIEWED]-(r:Person)
WITH m, collect(r) AS reviewers
WHERE size(reviewers) > 1
RETURN m
```

---

## 16. Checklist pr√©-examen

### üìã Auto-√©valuation (coche mentalement) :

**Concepts de base :**
- [ ] Je sais cr√©er un n≈ìud avec propri√©t√©s (`CREATE`)
- [ ] Je connais la diff√©rence entre `MATCH` et `CREATE`
- [ ] Je sais quand utiliser `->`, `<-` ou `-` dans les relations
- [ ] Je comprends pourquoi cr√©er en "un seul bloc"

**Requ√™tes interm√©diaires :**
- [ ] Je sais filtrer avec `WHERE`
- [ ] Je sais utiliser `DISTINCT` pour √©liminer les doublons
- [ ] Je sais calculer avec `avg()`, `count()`, `sum()`
- [ ] Je sais limiter les r√©sultats avec `LIMIT`

**Requ√™tes avanc√©es :**
- [ ] Je ma√Ætrise `collect()` pour agr√©ger en liste
- [ ] Je sais utiliser `UNWIND` pour exploser une liste
- [ ] Je comprends `WITH` pour encha√Æner des √©tapes
- [ ] Je sais √©viter les paires dupliqu√©es avec `elementId()`

**Chemins et exploration :**
- [ ] Je comprends `*1..` (au moins 1 relation)
- [ ] Je comprends `*1..3` (entre 1 et 3 relations)
- [ ] Je sais explorer un r√©seau depuis un n≈ìud

**Pi√®ges classiques :**
- [ ] Je n'utilise JAMAIS `CREATE` pour lier des n≈ìuds existants
- [ ] Je v√©rifie toujours la direction des relations
- [ ] Je pense √† `elementId()` pour les paires d'acteurs
- [ ] J'utilise `WITH` avant de filtrer sur des agr√©gations

---

## 17. Plan de r√©vision recommand√©

### üìÖ **Jour J-3 : Apprentissage**
**Temps : 2h**
- Lire sections 0-12 (toutes les requ√™tes du TP)
- Tester chaque requ√™te sur Neo4j Browser
- Noter les requ√™tes qui posent probl√®me

### üìÖ **Jour J-2 : Compr√©hension**
**Temps : 1h30**
- Relire section 13 (m√©thodologie)
- Refaire les requ√™tes probl√©matiques du J-3
- S'entra√Æner √† construire des requ√™tes sans regarder les r√©ponses

### üìÖ **Jour J-1 : Consolidation**
**Temps : 1h**
- Se tester avec la checklist (section 16)
- Relire section 15 (anti-patterns)
- Faire les questions 13.4 : ce que v√©rifient les examinateurs

### üìÖ **1h avant l'examen : Refresh**
**Temps : 15min**
- Relire uniquement :
  - 13.1 (direction des fl√®ches)
  - 13.2 (les 3 questions pour MATCH)
  - 15 (erreurs √† √©viter)

---

## 18. Questions types d'examen

### ‚≠ê Tr√®s probable (√† ma√Ætriser absolument) :

1. **Cr√©er un film et des acteurs** ‚Üí Section 0
2. **Trouver tous les acteurs d'un film** ‚Üí Section 4.2
3. **Personnes ayant r√©alis√© ET jou√©** ‚Üí Section 5
4. **Paires d'acteurs ayant jou√© ensemble** ‚Üí Section 8.1
5. **Films avec critiques multiples** ‚Üí Section 6.2
6. **Calculer un √¢ge moyen** ‚Üí Section 11-12

### ‚ö° Possible (bon √† savoir) :

7. **Exploration r√©seau avec chemins variables** ‚Üí Section 10
8. **R√©seau de followers** ‚Üí Section 9
9. **Top N avec ORDER BY + LIMIT** ‚Üí Section 12.2

### üéØ Pi√®ge classique :

**Question :** "Ajoutez l'acteur Brad Pitt au film Fight Club"

**‚ùå R√©ponse pi√®ge :**
```cypher
CREATE (brad:Person {name:"Brad Pitt"})-[:ACTED_IN]->(fight:Movie {title:"Fight Club"})
```

**‚úÖ Bonne r√©ponse :**
```cypher
MATCH (brad:Person {name:"Brad Pitt"})
MATCH (fight:Movie {title:"Fight Club"})
CREATE (brad)-[:ACTED_IN]->(fight)
```

---

**üí° Astuce r√©vision :** Comprendre la diff√©rence entre `CREATE` (cr√©ation) et `MATCH` (recherche) est essentiel. Ne jamais utiliser `CREATE` pour lier des n≈ìuds existants !

**üéØ Derni√®re astuce :** Si tu bloques √† l'examen, applique toujours les 3 questions de la section 13.2 :
1. Qu'est-ce que je cherche ?
2. D'o√π je pars ?
3. Quelle relation relie ces n≈ìuds ?