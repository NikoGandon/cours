# Création de nœuds et relations (CREATE)

## Créer un film et des acteurs - "The Departed"

**Important** : Exécuter tout le code en **un seul bloc** ! Sinon, les instructions CREATE pour les arcs doivent être précédées d'un MATCH pour récupérer les nœuds.

```sql
CREATE (departed:Movie {title:'The Departed', released:2006, tagline:'Good and Evil'})
CREATE (leo:Person {name:'Leonardo Di Caprio', born: 1974})
CREATE (matt:Person {name:'Matt Damon', born: 1970})
CREATE (leo)-[:ACTED_IN {roles: ['Billy']}]->(departed)
CREATE (matt)-[:ACTED_IN {roles: ['Colin Sullivan']}]->(departed)
```

**Ce que fait ce code :**

- Crée un nœud `Movie` avec les propriétés `title`, `released`, `tagline`
- Crée 2 nœuds `Person` avec les propriétés `name`, `born`
- Crée des relations `ACTED_IN` avec la propriété `roles`

## Ajouter une relation à un nœud existant

Si le nœud existe déjà (comme Jack Nicholson), il faut d'abord le récupérer avec `MATCH` :

```sql
MATCH (jack:Person {name: 'Jack Nicholson'})
MATCH (departed:Movie {title:'The Departed'})
CREATE (jack)-[:ACTED_IN {roles: ['Frank Costello']}]->(departed)
```

**Principe clé :** `CREATE` crée toujours de nouveaux nœuds. Pour lier des nœuds existants, on doit d'abord les `MATCH`.

# Visualiser tous les nœuds et relations

Affiche l'ensemble du graphe avec tous les nœuds, relations et leurs connexions.

```sql
MATCH (n)-[r]->(m)
RETURN n, r, m
```

**Résultat :** 174 nœuds et 256 relations

# Statistiques du graphe

Le graphe contient :

- **174 nœuds**
- **256 relations**

# Requêtes sur un film spécifique

## Relations autour de "The Departed"

Trouve toutes les entités connectées au film "The Departed" (acteurs, réalisateurs, etc.).

```sql
MATCH (m:Movie {title: "The Departed"})-[r]-(n)
RETURN m, r, n
```

**Note :** Le `-` (sans flèche) signifie "dans n'importe quelle direction".

# Relations Personne-Film

## Toutes les relations entre personnes et films

Affiche toutes les connexions entre les personnes et les films (peu importe le type de relation).

```sql
MATCH (p:Person)-[r]-(m:Movie)
RETURN p, r, m
```

## Uniquement les acteurs

Filtre pour n'afficher que les personnes ayant joué dans des films.

```sql
MATCH (p:Person)-[r:ACTED_IN]->(m:Movie)
RETURN p, r, m
```

# Réalisateurs-Acteurs

## Personnes ayant réalisé ET joué dans un même film

Trouve les personnes qui ont à la fois réalisé et joué dans le même film.

```sql
MATCH (p:Person)-[:DIRECTED]->(m:Movie)
MATCH (p)-[:ACTED_IN]->(m)
RETURN p, m
```

## Version optimisée avec un seul MATCH

Même requête mais avec une syntaxe plus concise.

```sql
MATCH (p:Person)-[:ACTED_IN]->(m:Movie)<-[:DIRECTED]-(p)
RETURN p, m
```

**Astuce :** La flèche `<-` indique la direction de la relation.

# Critiques de films

## Tous les critiques

Trouve toutes les personnes ayant critiqué des films.

```sql
MATCH (p:Person)-[r:REVIEWED]-(m:Movie)
RETURN p
```

## Films avec plusieurs critiques

Identifie les films ayant reçu plus d'une critique.

```sql
MATCH (m:Movie)-[:REVIEWED]-(reviewer:Person)
WITH m, collect(reviewer) AS reviewers
WHERE size(reviewers) > 1
RETURN m, reviewers
```

**Principe :** `WITH` permet d'agréger les résultats avant de filtrer.

# Filtres temporels

## Films récents (après 2010)

Liste tous les films sortis après 2010.

```sql
MATCH (m:Movie)
WHERE m.released > 2010
RETURN m
```

## Acteurs dans des films récents

Trouve les acteurs ayant joué dans des films sortis après 2010.

```sql
MATCH (actor:Person)-[r:ACTED_IN]->(m:Movie)
WHERE m.released > 2010
RETURN actor, m
```

# Co-acteurs

## Paires d'acteurs dans des films récents

Identifie les paires d'acteurs ayant joué ensemble dans des films post-2010.

```sql
MATCH (a1:Person)-[:ACTED_IN]->(m:Movie)<-[:ACTED_IN]-(a2:Person)
WHERE m.released > 2010 AND elementId(a1) < elementId(a2)
RETURN a1.name AS Acteur1, a2.name AS Acteur2, m.title AS Film, m.released AS Annee
```

**Note :** `elementId(a1) < elementId(a2)` évite les doublons (A-B et B-A).

## Co-acteurs récurrents

Trouve les paires d'acteurs ayant joué ensemble dans plusieurs films.

```sql
MATCH (a1:Person)-[:ACTED_IN]->(m:Movie)<-[:ACTED_IN]-(a2:Person)
WITH a1, a2, collect(m) AS movies
WHERE elementId(a1) < elementId(a2) AND size(movies) > 1
UNWIND movies AS movie
RETURN a1, a2, movie
```

**Principe :** `UNWIND` transforme une liste en lignes individuelles.

# Relations entre critiques

## Réseau de followers (version simple)

Trouve tous les critiques qui suivent d'autres critiques (jusqu'à plusieurs niveaux).

```sql
MATCH (reviewer1:Person)-[:FOLLOWS*1..]->(reviewer2:Person)
RETURN reviewer1, reviewer2
```

**Note :** `*1..` signifie "1 relation ou plus" (chemins de longueur variable).

## Réseau de followers (version groupée)

Pour chaque critique, affiche tous les critiques qu'il suit (directement ou indirectement).

```sql
MATCH (r1:Person)-[:FOLLOWS*1..]->(r2:Person)
RETURN r1.name AS reviewer, collect(DISTINCT r2.name) AS follows_network
```

**Amélioration :** Cette version regroupe les résultats par critique et élimine les doublons.

# Exploration du réseau

## Réseau de Clint Eastwood (3 degrés max)

Explore le réseau de Clint Eastwood jusqu'à 3 degrés de séparation.

```sql
MATCH (clint:Person {name: "Clint Eastwood"})
MATCH path = (clint)-[*1..3]-(n)
RETURN DISTINCT n
LIMIT 12
```

**Principe :** `[*1..3]` signifie "entre 1 et 3 relations de distance".

# Calculs d'âge

## Âge des acteurs dans "Apollo 13"

Calcule l'âge de chaque acteur lors du tournage d'Apollo 13.

```sql
MATCH (actor:Person)-[:ACTED_IN]->(m:Movie {title: "Apollo 13"})
RETURN m, actor.name, m.released - actor.born AS age_lors_tournage
```

## Âge moyen du casting d'Apollo 13

Calcule l'âge moyen des acteurs d'Apollo 13 lors du tournage.

```sql
MATCH (actor:Person)-[:ACTED_IN]->(m:Movie {title: "Apollo 13"})
RETURN m, avg(m.released - actor.born) AS age_moyen
```

**Fonction :** `avg()` calcule la moyenne.

# Analyses statistiques

## Âge moyen par film

Calcule l'âge moyen des acteurs pour chaque film.

```sql
MATCH (m:Movie)<-[:ACTED_IN]-(actor:Person)
RETURN m, avg(m.released - actor.born) AS age_moyen
```

## Top 10 des films avec les castings les plus jeunes

Classe les films par âge moyen des acteurs (du plus jeune au plus âgé).

```sql
MATCH (m:Movie)<-[:ACTED_IN]-(actor:Person)
RETURN m, avg(m.released - actor.born) AS age_moyen
ORDER BY age_moyen ASC
LIMIT 10
```

**Clauses :** `ORDER BY` trie les résultats, `LIMIT` restreint le nombre de lignes.

# Corrections et bonnes pratiques

## Erreurs courantes corrigées :

1. **Créer des relations sans MATCH préalable** : Si le nœud existe déjà, il faut le récupérer avec `MATCH` avant de créer une relation
2. **Variable `actor` non définie** : Toujours définir la variable dans le `MATCH`
3. **Direction des relations** : `(m:Movie)-[r:ACTED_IN]-(actor)` $\to$ Correct : `(m:Movie)<-[:ACTED_IN]-(actor)`

## Conseils Neo4j :

- **`elementId()`** : Pour éviter les doublons dans les paires (A-B vs B-A)
- **`collect()`** : Pour agréger des résultats en liste
- **`DISTINCT`** : Élimine les doublons dans les résultats
- **`*1..` ou `*1..3`** : Pour les chemins de longueur variable
- **`WITH`** : Pour enchaîner des étapes de traitement (agrégation puis filtrage)
- **`UNWIND`** : Pour transformer une liste en lignes
- **CREATE en bloc** : Toujours créer nœuds + relations en un seul bloc si possible

## Syntaxe des relations :

- `(a)-[r]->(b)` : relation dirigée de a vers b
- `(a)-[r]-(b)` : relation dans n'importe quelle direction
- `(a)<-[r]-(b)` : relation de b vers a
- `(a)-[:TYPE]->(b)` : relation avec un type spécifique
- `(a)-[*1..3]->(b)` : chemin de 1 à 3 relations

# Résumé des fonctions utiles

| Fonction      | Usage               | Exemple                |
| ------------- | ------------------- | ---------------------- |
| count()       | Compte les éléments | RETURN count(n)        |
| avg()         | Moyenne             | RETURN avg(m.released) |
| sum()         | Somme               | RETURN sum(m.budget)   |
| min() / max() | Min / Max           | RETURN max(m.released) |
| collect()     | Agrège en liste     | collect(actor.name)    |
| size()        | Taille d'une liste  | size(movies)           |
| elementId()   | ID unique du nœud   | elementId(n)           |

# Anti-patterns : Erreurs à éviter absolument

## Erreur 1 : Créer au lieu de lier

**MAUVAIS :**

```sql
CREATE (p:Person {name:"Jack"})-[:ACTED_IN]->(m:Movie {title:"Film"})
```

**Problème :** Crée TOUJOURS de nouveaux nœuds, même s'ils existent déjà $\to$ doublons garantis !

**BON :**

```sql
MATCH (p:Person {name:"Jack"})
MATCH (m:Movie {title:"Film"})
CREATE (p)-[:ACTED_IN]->(m)
```

## Erreur 2 : Oublier d'éviter les doublons dans les paires

**MAUVAIS :**

```sql
MATCH (a1:Person)-[:ACTED_IN]->(m)<-[:ACTED_IN]-(a2:Person)
RETURN a1, a2, m
```

**Problème :** Retourne Tom-Jerry ET Jerry-Tom (doublon)

**BON :**

```sql
MATCH (a1:Person)-[:ACTED_IN]->(m)<-[:ACTED_IN]-(a2:Person)
WHERE elementId(a1) < elementId(a2)
RETURN a1, a2, m
```

## Erreur 3 : Mauvaise direction de relation

**MAUVAIS :**

```sql
MATCH (m:Movie)-[:ACTED_IN]->(p:Person)  // Film joue dans personne ???
RETURN p
```

**BON :**

```sql
MATCH (p:Person)-[:ACTED_IN]->(m:Movie)  // Personne joue dans film
RETURN p
```

## Erreur 4 : Filtrer avant d'agréger

**MAUVAIS :**

```sql
MATCH (m:Movie)<-[:REVIEWED]-(r:Person)
WHERE count(r) > 1  // count() ne fonctionne pas ici !
RETURN m
```

**BON :**

```sql
MATCH (m:Movie)<-[:REVIEWED]-(r:Person)
WITH m, collect(r) AS reviewers
WHERE size(reviewers) > 1
RETURN m
```

# A savoir

## Absolument :

1. **Créer un film et des acteurs** $\to$ Section 0
2. **Trouver tous les acteurs d'un film** $\to$ Section 4.2
3. **Personnes ayant réalisé ET joué** $\to$ Section 5
4. **Paires d'acteurs ayant joué ensemble** $\to$ Section 8.1
5. **Films avec critiques multiples** $\to$ Section 6.2
6. **Calculer un âge moyen** $\to$ Section 11-12

## bon à savoir :

7. **Exploration réseau avec chemins variables** $\to$ Section 10
8. **Réseau de followers** $\to$ Section 9
9. **Top N avec ORDER BY + LIMIT** $\to$ Section 12.2

## Piège :

**Question :** "Ajoutez l'acteur Brad Pitt au film Fight Club"

**Réponse piège :**

```sql
CREATE (brad:Person {name:"Brad Pitt"})-[:ACTED_IN]->(fight:Movie {title:"Fight Club"})
```

**Bonne réponse :**

```sql
MATCH (brad:Person {name:"Brad Pitt"})
MATCH (fight:Movie {title:"Fight Club"})
CREATE (brad)-[:ACTED_IN]->(fight)
```

**Dernière astuce :** Si je bloque, je peux me demander :

1. Qu'est-ce que je cherche ?
2. D'où je pars ?
3. Quelle relation relie ces nœuds ?
